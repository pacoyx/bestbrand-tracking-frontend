<div class="container-trackpedidos">
  <div
    style="
      display: flex;
      justify-content: space-between;
      border: 1px solid gainsboro;
      border-radius: 5px;
      padding: 5px;
      margin-bottom: 5px;
    "
  >
    <div style="display: flex; gap: 5px; align-items: center">
      <mat-icon>co_present</mat-icon>
      <label><strong>Asignar Pedidos</strong></label>
    </div>
  </div>

  <mat-stepper [linear]="isLinear" #stepper>
    <mat-step
      label="Empresa de Transporte"
      [stepControl]="asignarForm"
      state="driver"
    >
      <div class="container-Step1">
        <div class="section-controls-main">
          <div style="width: 100%; display: flex; justify-content: flex-end">
            <button mat-button matStepperNext (click)="nextStepForm()">
              Next
            </button>
          </div>
        </div>
        <div class="container-form">
          <form
            [formGroup]="asignarForm"
            style="padding: 5px; display: flex; flex-direction: column"
          >
            <mat-form-field appearance="outline">
              <mat-label>Empresa Transportista</mat-label>
              <mat-select formControlName="empresa">
                @for (item of empresas; track item.id) {
                <mat-option [value]="item.id">
                  {{ item.razonSocial }}
                </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Conductor</mat-label>
              <mat-select formControlName="conductor">
                @for (item of conductores; track item.id) {
                <mat-option [value]="item.id"> {{ item.nombre }} </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Vehiculo</mat-label>
              <mat-select formControlName="vehiculo">
                @for (item of vehiculos; track item.id) {
                <mat-option [value]="item.id"> {{ item.placa }} </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Comentarios</mat-label>
              <textarea
                matInput
                formControlName="comentarios"
                rows="3"
              ></textarea>
            </mat-form-field>
          </form>
        </div>
      </div>
    </mat-step>
    <mat-step label="Seleccione Pedidos" state="orders">
      <div class="container-Step2">
        <div class="section-controls-main">
          <div class="section-controls">
            <mat-form-field>
              <mat-label>Seleccione fecha</mat-label>
              <input matInput [matDatepicker]="picker" [(ngModel)]="fechaHoy" />
              <mat-hint>DD/MM/YYYY</mat-hint>
              <mat-datepicker-toggle
                matIconSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>
            <button
              mat-fab
              extended
              (click)="cargarPedidos()"
              [disabled]="loading"
            >
              <mat-icon>search</mat-icon>
              Buscar
            </button>
            @if (loading) {
            <div style="display: flex; align-items: center; gap: 5px">
              <app-loading [diameter]="30"></app-loading>
              Cargando pedidos...
            </div>
            }
          </div>
          <div style="display: flex; align-items: center">
            <button mat-button matStepperPrevious>Back</button>
            <button mat-button matStepperNext (click)="nextStepOrder()">
              Next
            </button>
          </div>
        </div>
        <div class="container-table">
          <table
            mat-table
            [dataSource]="dataSource"
            matSort
            class="mat-elevation-z8"
            multiTemplateDataRows
          >
            <!-- Checkbox Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox
                  (change)="$event ? toggleAllRows() : null"
                  [checked]="selection.hasValue() && isAllSelected()"
                  [indeterminate]="selection.hasValue() && !isAllSelected()"
                  [aria-label]="checkboxLabel()"
                >
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let row">
                <mat-checkbox
                  (click)="$event.stopPropagation()"
                  (change)="$event ? selection.toggle(row) : null"
                  [checked]="selection.isSelected(row)"
                  [aria-label]="checkboxLabel(row)"
                >
                </mat-checkbox>
              </td>
            </ng-container>

            <ng-container matColumnDef="prioridad">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Prioridad
              </th>
              <td mat-cell *matCellDef="let element">
                {{ element.prioridad }}
              </td>
            </ng-container>

            <ng-container matColumnDef="nropedido">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Nro Pedido
              </th>
              <td mat-cell *matCellDef="let element">
                {{ element.numero }}
              </td>
            </ng-container>

            <ng-container matColumnDef="cliente">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
              <td mat-cell *matCellDef="let element">
                {{ element.cliente }}
              </td>
            </ng-container>

            <ng-container matColumnDef="direntrega">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Direccion Entrega
              </th>
              <td mat-cell *matCellDef="let element">
                {{ element.direccionEntrega }}
              </td>
            </ng-container>

            <ng-container matColumnDef="ubigeo">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Ubigeo</th>
              <td mat-cell *matCellDef="let element">
                <div style="display: flex; flex-direction: column">
                  <div style="border-bottom: 1px solid gainsboro">
                    {{ element.departamento }}
                  </div>
                  <div style="border-bottom: 1px solid gainsboro">
                    {{ element.provincia }}
                  </div>
                  <div>
                    {{ element.distrito }}
                  </div>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="docguia">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Num. Guia
              </th>
              <td mat-cell *matCellDef="let element">
                <div style="display: flex; flex-direction: column">
                  <div>
                    {{ element.serieGuia }}
                  </div>
                  <div>
                    {{ element.numeroGuia }}
                  </div>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="transportista">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Transportista
              </th>
              <td mat-cell *matCellDef="let element">
                <div style="display: flex; flex-direction: column">
                  <div style="border-bottom: 1px solid gainsboro">
                    {{ element.transEmpresa }}
                  </div>
                  <div style="border-bottom: 1px solid gainsboro; color: blue">
                    {{ element.transConductor }}
                  </div>
                  <div>
                    {{ element.transVehiculo }}
                  </div>
                </div>
              </td>
            </ng-container>

            /* CANCELADO ENTREGADO EN_TRANSITO PENDIENTE*/

            <ng-container matColumnDef="estadopedido">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Estado Pedido
              </th>
              <td mat-cell *matCellDef="let element">
                {{ element.estadoPedido }}
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="displayedColumns"
              class="cabecera"
            ></tr>

            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              (click)="selection.toggle(row)"
            ></tr>
          </table>
        </div>
      </div>
    </mat-step>
    <mat-step label="Prioridad de Pedidos" state="priority">
      <div class="container-Step1">
        <div class="section-controls-main">
          <div style="width: 100%; display: flex; justify-content: flex-end">
            <button mat-button matStepperPrevious>Back</button>
            <button mat-button (click)="stepper.reset()">Reset</button>
          </div>
        </div>

        <div style="width: 100%; display: flex; gap: 20px">
          <div
            style="width: 50%; display: flex; flex-direction: column; gap: 5px"
          >
            <div class="section-info">
              <mat-icon>information</mat-icon>
              <span
                >Arrastra y suelta los pedidos para cambiar su prioridad</span
              >
            </div>
            <div
              cdkDropList
              class="example-list"
              (cdkDropListDropped)="drop($event)"
            >
              @for (pedido of itemsPedidos; track pedido; let i = $index) {
              <div class="example-box" cdkDrag>
                <div style="width: 100%; display: table; table-layout: fixed">
                  <div style="display: table-row">
                    <div
                      style="
                        display: table-cell;
                        width: 40px;
                        min-width: 40px;
                        vertical-align: middle;
                        text-align: center;
                      "
                    >
                      <mat-icon>menu</mat-icon>
                    </div>
                    <div
                      style="
                        display: table-cell;
                        width: 100px;
                        min-width: 100px;
                        vertical-align: middle;
                        text-align: center;
                        color: #666;
                        font-size: 0.8em;
                      "
                    >
                      Prioridad: {{ i + 1 }}
                    </div>
                    <div
                      style="
                        display: table-cell;
                        min-width: 100px;
                        max-width: 120px;
                        vertical-align: middle;
                        padding: 0 8px;
                        word-wrap: break-word;
                      "
                    >
                      {{ pedido.numero }}
                    </div>
                    <div
                      style="
                        display: table-cell;
                        min-width: 150px;
                        vertical-align: middle;
                        padding: 0 8px;
                        word-wrap: break-word;
                      "
                    >
                      {{ pedido.cliente }}
                    </div>
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
          <div style="width: 50%">
            <div class="section-info">
              <mat-icon>airport_shuttle</mat-icon>
              <span>Transportista</span>
            </div>
            <div class="section-step3-transportista">
              <div><strong>Empresa:</strong> {{ empresaSeleccionada }}</div>
              <div><strong>Conductor:</strong> {{ conductorSeleccionado }}</div>
              <div><strong>Vehiculo:</strong> {{ vehiculoSeleccionado }}</div>
              <div style="margin-top: 10px">
                <strong>Comentarios:</strong>
                <div style="margin-top: 5px">
                  {{ comentariosSeleccionado }}
                </div>
              </div>
            </div>
            <div class="section-info">
              <mat-icon>check_box</mat-icon>
              <span>Confirmar Asignación</span>
            </div>
            <div>
              <div
                style="
                  display: flex;
                  flex-direction: column;
                  gap: 10px;
                  padding: 10px;
                "
              >
                <div>
                  <strong>Cantidad de Pedidos:</strong>
                  {{ itemsPedidos.length }}
                </div>
                <p>¿Estás seguro de que deseas asignar este pedido?</p>
                <button
                  mat-fab
                  extended
                  (click)="RegistrarAsignarPedido()"
                  [disabled]="saving"
                >
                  <mat-icon>garage_check</mat-icon>
                  @if(saving){
                  <app-loading [diameter]="20"></app-loading>
                  Grabando... }@else { Registrar Asignación }
                </button>

                <!-- <pre>
                    {{ itemsPedidos | json }}
                </pre>

                <pre>
                    {{ selection | json }}
                </pre> -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-step>

    <ng-template matStepperIcon="driver">
      <mat-icon>person_check</mat-icon>
    </ng-template>
    <ng-template matStepperIcon="orders">
      <mat-icon>shopping_cart</mat-icon>
    </ng-template>
    <ng-template matStepperIcon="priority">
      <mat-icon>sort</mat-icon>
    </ng-template>
  </mat-stepper>
</div>